<!DOCTYPE html>
<html>
<head>
  <title>Image Gallery</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style type="text/css">
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
  function App () {

    const { useState, useRef, useEffect } = React

    // ---------------------------------------------------------------------------------------------------------------------
    // state
    // ---------------------------------------------------------------------------------------------------------------------

    const [images, setImages] = useState([])
    const [loading, setLoading] = useState(true)
    const [error, setError] = useState(null)

    useEffect(() => {
      Api.load()
    }, [])

    // ---------------------------------------------------------------------------------------------------------------------
    // api
    // ---------------------------------------------------------------------------------------------------------------------

    const Api = {
      async load () {
        fetch('/cache')
          .then(response => response.json())
          .then(data => {
            setImages(data)
            setLoading(false)
          })
          .catch(err => {
            setError(err.message)
            setLoading(false)
          })
      },

      async print (name) {
        const res = await fetch(`http://localhost:4000/print?name=${name}`)
        if (res.status === 200) {
          notify(`Printing ${name}`, 'success')
        }
      },

      async remove (name) {
        const res = await fetch(`http://localhost:4000/remove?name=${name}`)
        if (res.status === 200) {
          const index = images.findIndex((image) => image.name === name)
          if (index > -1) {
            images.splice(index, 1)
            setImages([...images])
            notify(`Removed ${name}`, 'info')
          }
        }
      },

      async clear () {
        const res = await fetch(`http://localhost:4000/clear?`)
        setImages([])
        notify(await res.text(), 'info')
      },
    }

    // ---------------------------------------------------------------------------------------------------------------------
    // notifications
    // ---------------------------------------------------------------------------------------------------------------------

    const [notifications, setNotifications] = useState([])

    const notify = (message, status = 'info') => {
      const id = Date.now()
      setNotifications(prev => [...prev, { id, message, status }])
      // Just set the timeout right here when we create the notification
      setTimeout(() => {
        setNotifications(prev => prev.filter(n => n.id !== id))
      }, 3000)
    }

    const NotificationContainer = () => {
      return (
        <div className="fixed bottom-4 right-6 flex flex-col-reverse items-end">
          {notifications.map(({ id, message, status }) => (
            <div key={id}>
              <div
                className={`
                  inline-block py-2 px-3 mb-2 rounded-lg text-sm animate-fade-in
                  ${status === 'success' ? 'bg-green-100 text-green-600' : ''}
                  ${status === 'error' ? 'bg-red-100 text-red-600' : ''}
                  ${status === 'info' ? 'bg-blue-100 text-blue-600' : ''}
                `}
              >
                {message}
              </div>
            </div>
          ))}
        </div>
      )
    }

    // ---------------------------------------------------------------------------------------------------------------------
    // components
    // ---------------------------------------------------------------------------------------------------------------------

    const UploadIcon = ({ className }) => (
      <svg
        className={className}
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
      >
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
    )

    const ImageUploader = () => {
      const [isDragging, setIsDragging] = useState(false)
      const fileInputRef = useRef(null)

      console.log({ fileInputRef })

      const handleDrag = (e) => {
        e.preventDefault()
        e.stopPropagation()
      }

      const handleDragIn = (e) => {
        e.preventDefault()
        e.stopPropagation()
        setIsDragging(true)
      }

      const handleDragOut = (e) => {
        e.preventDefault()
        e.stopPropagation()
        setIsDragging(false)
      }

      const resetFileInput = () => {
        if (fileInputRef.current) {
          fileInputRef.current.value = ''
        }
      }

      const handleFileUpload = async (file) => {
        if (file && file.type.startsWith('image/')) {
          const formData = new FormData()
          formData.append('image', file)

          try {
            const response = await fetch('http://localhost:4000/print', {
              method: 'POST',
              body: formData,
            })

            const data = await response.json()
            console.log('Server response:', data)
            notify(`Printing ${file.name}`, 'success')
            void Api.load()
          }
          catch (error) {
            // Reset after error
            notify(error.message, 'error')
          }
          finally {
            resetFileInput()
          }
        }
        else {
          notify('Please select an image file')
        }
      }

      const handleDrop = async (e) => {
        e.preventDefault()
        e.stopPropagation()
        setIsDragging(false)

        const files = [...e.dataTransfer.files]
        if (files.length > 0) {
          await handleFileUpload(files[0])
        }
      }

      const handleClick = (e) => {
        if (e.target !== fileInputRef.current) {
          fileInputRef.current?.click()
        }
      }

      const handleFileSelect = async (e) => {
        const files = [...e.target.files]
        console.log('Handle File Select', files)
        if (files.length > 0) {
          await handleFileUpload(files[0])
        }
      }

      return (
        <div
          onClick={handleClick}
          onDragEnter={handleDragIn}
          onDragLeave={handleDragOut}
          onDragOver={handleDrag}
          onDrop={handleDrop}
          className={`
          h-full flex flex-col items-center justify-center
          cursor-pointer
          group
          ${isDragging
            ? 'bg-blue-50'
            : 'hover:bg-gray-50'
          }
        `}
        >
          <input
            ref={fileInputRef}
            type="file"
            accept="image/*"
            className="hidden"
            onInputCapture={handleFileSelect}
          />

          <div className={`
            px-4 py-6 h-64
            pointer-events-none
            text-center
            ${isDragging ? 'text-blue-700' : 'text-gray-500 group-hover:text-gray-900'}
          `}>
            <UploadIcon className={`
              w-24 h-24 mx-auto mb-4 opacity-30
            `}/>

            <p className="text-lg font-medium mb-2">
              {isDragging ? 'Drop image here' : 'Drag and drop an image to print'}
            </p>

            <p className="mb-2 text-sm opacity-75">
              or click to browse
            </p>
          </div>
        </div>
      )
    }

    // ---------------------------------------------------------------------------------------------------------------------
    // image gallery
    // ---------------------------------------------------------------------------------------------------------------------

    const ImageGallery = () => {
      return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {images.map((image, index) => (
            <div data-id="thumbnail" key={index} className="relative">
              <ImageThumbnail image={image}/>
            </div>
          ))}
        </div>
      )
    }

    const ImageThumbnail = ({ image }) => {
      const { path, name } = image
      return (
        <div
          data-id="thumbnail_wrapper"
          className="flex flex-col gap-2 p-3 rounded-lg outline outline-2 outline-dashed outline-gray-200 hover:outline-blue-500"
          onClick={() => Api.print(name)}
        >
        <span
          data-id="thumbnail__close"
          className="absolute right-0 top-0 p-2 leading-none text-xl font-bold text-gray-200 hover:text-red-500 cursor-pointer"
          onClick={(e) => {
            e.stopPropagation()
            Api.remove(name)
          }}
        >&times;</span>
          <img
            data-id="thumbnail__image"
            src={path}
            className="max-w-48 max-h-36 object-contain"
            loading="lazy"
          />
          <p className="text-xs text-blue-500">{name}</p>
        </div>
      )
    }

    // ---------------------------------------------------------------------------------------------------------------------
    // image list
    // ---------------------------------------------------------------------------------------------------------------------

    const ImageText = ({ image }) => {
      const { name } = image
      return (
        <div
          className="
            group
            flex items-center justify-between
            py-2 pl-4 pr-2
            rounded-lg leading-none
            hover:bg-gray-50 cursor-pointer
          "
          onClick={() => Api.print(name)}
        >
          <span className="text-sm text-gray-600 group-hover:text-gray-900">{name}</span>
          <span
            className="
              block h-full
              px-3 py-1 -m-2
              text-lg font-bold opacity-0
              group-hover:opacity-100 text-gray-400 hover:text-red-500 hover:bg-gray-500/10
              rounded-r-lg
              cursor-pointer
            "
            onClick={(e) => {
              e.stopPropagation()
              Api.remove(name)
            }}
          >&times;</span>
        </div>
      )
    }

    const ImageList = () => {
      return (
        <div className="flex flex-col px-4 py-6 overflow-y-auto">
          {images.map((image, index) => (
            <div data-id="text" key={index} className="relative">
              <ImageText image={image}/>
            </div>
          ))}
        </div>
      )
    }

    const ImageManager = () => {
      return (
        <div className="flex flex-col h-full">
          <ImageList/>
        </div>
      )
    }

    // ---------------------------------------------------------------------------------------------------------------------
    // app
    // ---------------------------------------------------------------------------------------------------------------------

    if (loading) {
      return (
        <div className="flex items-center justify-center min-h-screen">
          <p className="text-xl">Loading images...</p>
        </div>
      )
    }

    if (error) {
      return (
        <div className="flex items-center justify-center min-h-screen">
          <p className="text-xl text-red-500">Error loading images: {error}</p>
        </div>
      )
    }

    return (
      <div>
        <div className="flex h-screen">
          <div className="flex-1 border-r">
            <ImageUploader/>
          </div>
          {images.length > 0 && (
            <div className="w-96 overflow-y-auto">
              <ImageManager/>
            </div>
          )}
        </div>
        <NotificationContainer/>
      </div>
    )
  }

  ReactDOM.render(<App/>, document.getElementById('root'))
</script>
</body>
</html>
